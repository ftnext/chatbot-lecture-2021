
<!DOCTYPE html>

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChatterBotのチャットボットとWebアプリでやり取りできるようにする &#8212; chatbot-lecture-2021  ドキュメント</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/translations.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="検索" href="../search.html" />
    <link rel="next" title="参考文献" href="../reference.html" />
    <link rel="prev" title="チャットボットとやり取りできるようにする" href="../50-send-message-django-app/index.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="chatterbotweb">
<h1>ChatterBotのチャットボットとWebアプリでやり取りできるようにする<a class="headerlink" href="#chatterbotweb" title="この見出しへのパーマリンク">¶</a></h1>
<div class="section" id="id1">
<h2>今回の位置づけ<a class="headerlink" href="#id1" title="この見出しへのパーマリンク">¶</a></h2>
<div class="section" id="id2">
<h3>前回までの復習<a class="headerlink" href="#id2" title="この見出しへのパーマリンク">¶</a></h3>
<ul class="simple">
<li>チャットボット＝自動応答するプログラム（<a class="reference internal" href="../10-overview/index.html#what-is-chatbot"><span class="std std-ref">チャットボットの概要</span></a>）</li>
<li>ライブラリ <code class="docutils literal notranslate"><span class="pre">chatterbot</span></code> を使ったPythonスクリプトをまず動かした</li>
<li>スクリプトだけでなく、Webアプリとしてもチャットボットを動かしたい</li>
<li>オウム返しするチャットボットとやり取りするWebアプリを作った</li>
</ul>
</div>
<div class="section" id="id3">
<h3>今回やること<a class="headerlink" href="#id3" title="この見出しへのパーマリンク">¶</a></h3>
<ul class="simple">
<li>Pythonスクリプトのチャットボット（コーパスから訓練）をWebアプリで動かす<ul>
<li>訓練（Pythonスクリプトの訓練）</li>
<li>応答（画面でやり取りできるようにする）</li>
</ul>
</li>
</ul>
<div class="section" id="id4">
<h4>前回の開発の続きができるように準備<a class="headerlink" href="#id4" title="この見出しへのパーマリンク">¶</a></h4>
<p>前回の状態のファイルをzipにまとめて配布しています。
前回の「<a class="reference internal" href="../50-send-message-django-app/index.html#intro03"><span class="std std-ref">今回の位置づけ</span></a>」の「前回の開発の続きができるように準備」を参照して、準備してください（手順は共通です）。</p>
<p>前回の状態のアプリケーションが手元で動いている状態が、今回の前提になっています。</p>
</div>
</div>
</div>
<div class="section" id="django">
<h2>Djangoのカスタムコマンド<a class="headerlink" href="#django" title="この見出しへのパーマリンク">¶</a></h2>
<div class="section" id="id5">
<h3>カスタムコマンドとは<a class="headerlink" href="#id5" title="この見出しへのパーマリンク">¶</a></h3>
<p>Djangoの <strong>カスタムコマンド</strong> という仕組みを使います。
アプリケーションごとにコマンドを持たされます。</p>
<p>開発者が使えるよう、Djangoにデフォルトで用意されているコマンドがあります。
<strong class="command">python manage.py --help</strong> でコマンドの一覧が見られます。</p>
<ul class="simple">
<li>例えば、<strong class="command">runserver</strong> は <code class="docutils literal notranslate"><span class="pre">django</span></code> アプリケーションのコマンドです。</li>
</ul>
<p>カスタムコマンドを実装して、このコマンド一覧にチャットボットを訓練するコマンドを追加します。</p>
</div>
<div class="section" id="id6">
<h3>カスタムコマンドに必要なディレクトリ構成<a class="headerlink" href="#id6" title="この見出しへのパーマリンク">¶</a></h3>
<p>Djangoのカスタムコマンドは <strong>ディレクトリ構成のルールが決まっています</strong>。
ルールに沿ってディレクトリとファイルを配置し、実装します。</p>
<p><a class="reference external" href="https://docs.djangoproject.com/ja/3.2/howto/custom-management-commands/" rel="noopener noreferrer" target="_blank">https://docs.djangoproject.com/ja/3.2/howto/custom-management-commands/</a></p>
<blockquote>
<div>独自のコマンドを追加するためには、<a href="#id7"><span class="problematic" id="id8">``</span></a>management/commands``ディレクトリをアプリケーションに追加してください。</div></blockquote>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ mkdir -p chat/management/commands
$ touch chat/management/__init__.py
$ touch chat/management/commands/__init__.py
$ touch chat/management/commands/bot_train.py
</pre></div>
</div>
<p><code class="file docutils literal notranslate"><span class="pre">__init__.py</span></code> はPythonパッケージにするために置きます。
中身は空で大丈夫です。</p>
<p><code class="file docutils literal notranslate"><span class="pre">chat/management/commands/bot_train.py</span></code> を編集していきます。</p>
</div>
<div class="section" id="id9">
<h3>初めてのカスタムコマンド！<a class="headerlink" href="#id9" title="この見出しへのパーマリンク">¶</a></h3>
<p>まずは、簡単なカスタムコマンドを作りましょう。
<code class="file docutils literal notranslate"><span class="pre">chat/management/commands/bot_train.py</span></code> に以下を書いてください。</p>
<div class="literal-block-wrapper docutils container" id="id21">
<div class="code-block-caption"><span class="caption-text">chat/management/commands/bot_train.py</span><a class="headerlink" href="#id21" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="kn">from</span> <span class="nn">django.core.management.base</span> <span class="kn">import</span> <span class="n">BaseCommand</span>
<span class="linenos">2</span>
<span class="linenos">3</span>
<span class="linenos">4</span><span class="k">class</span> <span class="nc">Command</span><span class="p">(</span><span class="n">BaseCommand</span><span class="p">):</span>
<span class="linenos">5</span>    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos">6</span>        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;bot_trainコマンドです&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>実行してみましょう。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ python manage.py bot_train
bot_trainコマンドです
</pre></div>
</div>
<p><strong class="command">python manage.py --help</strong> で見られるコマンド一覧にも追加されていることが確認できます。</p>
<div class="section" id="id10">
<h4>プログラムの解説<a class="headerlink" href="#id10" title="この見出しへのパーマリンク">¶</a></h4>
<p>アプリケーションの <code class="file docutils literal notranslate"><span class="pre">management/commands</span></code> に置いたファイルの名前がコマンド名になります（<code class="docutils literal notranslate"><span class="pre">bot_train</span></code>）。</p>
<p>ファイル名以外にも、カスタムコマンドでは「こう実装してください」というルールが決まっています。</p>
<blockquote>
<div>BaseCommand クラスもしくはその サブクラス の一つを継承した Command クラスを定義する必要が有ります。</div></blockquote>
<p><a class="reference external" href="https://docs.djangoproject.com/ja/3.2/howto/custom-management-commands/" rel="noopener noreferrer" target="_blank">https://docs.djangoproject.com/ja/3.2/howto/custom-management-commands/</a></p>
<p>これに沿って <code class="docutils literal notranslate"><span class="pre">Command</span></code> クラスを実装しています（4行目）。</p>
<p><code class="docutils literal notranslate"><span class="pre">Command</span></code> クラスには <code class="docutils literal notranslate"><span class="pre">handle</span></code> というインスタンスメソッドを実装します。
コマンドラインに出力するために <code class="docutils literal notranslate"><span class="pre">self.stdout.write</span></code> を使います。</p>
<blockquote>
<div>管理コマンドを利用してコンソールへの標準出力を行いたい場合、stdout と stderr に直接文字列を渡すのではなく、self.stdout および self.stderr を利用するべきです。（上と同じリンクより）</div></blockquote>
<div class="admonition hint">
<p class="first admonition-title">ヒント</p>
<p>色付きでコマンドラインに出力できる</p>
<p><code class="docutils literal notranslate"><span class="pre">self.stdout.write</span></code> の引数に、色などの <strong>スタイル</strong> を指定した文字列を渡せます。</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">self.style.SUCCESS(&quot;bot_trainコマンドです&quot;)</span></code> ：緑色で表示されます</li>
<li><code class="docutils literal notranslate"><span class="pre">self.style.ERROR(&quot;bot_trainコマンドです&quot;)</span></code> ：赤色で表示されます</li>
</ul>
<p class="last">引数 <code class="docutils literal notranslate"><span class="pre">&quot;bot_trainコマンドです&quot;</span></code> を上記に変えて試してみてください。
スタイル指定は訓練コマンドでも使います。</p>
</div>
</div>
</div>
</div>
<div class="section" id="id11">
<h2>チャットボット訓練コマンド<a class="headerlink" href="#id11" title="この見出しへのパーマリンク">¶</a></h2>
<p><a class="reference internal" href="../30-chatterbot-first-step/index.html#corpus-train-ja-bot"><span class="std std-ref">コーパスを使って訓練したチャットボット（日本語）</span></a> で行ったのと同じ訓練を、Webアプリでもできるようにします。
<strong class="command">bot_train</strong> コマンドを実装します。</p>
<p>以下のファイルを変更します。</p>
<ul class="simple">
<li>プロジェクトの <code class="file docutils literal notranslate"><span class="pre">settings.py</span></code></li>
<li>アプリケーションの <code class="file docutils literal notranslate"><span class="pre">management/commands/bot_train.py</span></code></li>
</ul>
<div class="section" id="id12">
<h3>設定変更<a class="headerlink" href="#id12" title="この見出しへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">INSTALLED_APPS</span></code> にChatterBotのDjangoアプリケーションを追加</li>
<li>ChatterBot用の設定を示す変数を追加</li>
</ul>
<div class="section" id="installed-apps">
<h4><code class="docutils literal notranslate"><span class="pre">INSTALLED_APPS</span></code><a class="headerlink" href="#installed-apps" title="この見出しへのパーマリンク">¶</a></h4>
<div class="literal-block-wrapper docutils container" id="id22">
<div class="code-block-caption"><span class="caption-text">app/djangochatbot/settings.py</span><a class="headerlink" href="#id22" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;django.contrib.admin&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.auth&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.contenttypes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.sessions&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.messages&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.staticfiles&#39;</span><span class="p">,</span>

    <span class="s2">&quot;chat.apps.ChatConfig&quot;</span><span class="p">,</span>

<span class="hll">    <span class="s2">&quot;chatterbot.ext.django_chatterbot&quot;</span><span class="p">,</span>
</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>参考：<a class="reference external" href="https://chatterbot.readthedocs.io/en/stable/django/index.html#installed-apps" rel="noopener noreferrer" target="_blank">https://chatterbot.readthedocs.io/en/stable/django/index.html#installed-apps</a></p>
</div>
<div class="section" id="chatterbot">
<h4>ChatterBot用の設定追加<a class="headerlink" href="#chatterbot" title="この見出しへのパーマリンク">¶</a></h4>
<p><a class="reference internal" href="../30-chatterbot-first-step/index.html#corpus-train-ja-bot"><span class="std std-ref">コーパスを使って訓練したチャットボット（日本語）</span></a> で作ったスクリプトは、以下のように <code class="docutils literal notranslate"><span class="pre">ChatBot</span></code> クラスのインスタンスを初期化しています。</p>
<div class="literal-block-wrapper docutils container" id="id23">
<div class="code-block-caption"><span class="caption-text">my_chatbot.py</span><a class="headerlink" href="#id23" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">11</span>    <span class="n">chatbot</span> <span class="o">=</span> <span class="n">ChatBot</span><span class="p">(</span><span class="s2">&quot;Training from corpus bot&quot;</span><span class="p">,</span> <span class="n">tagger_language</span><span class="o">=</span><span class="n">CustomJPN</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>この引数をプロジェクトの <code class="file docutils literal notranslate"><span class="pre">settings.py</span></code> で指定します。
末尾に追加してください。</p>
<div class="literal-block-wrapper docutils container" id="id24">
<div class="code-block-caption"><span class="caption-text">app/djangochatbot/settings.py</span><a class="headerlink" href="#id24" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ChatterBot settings</span>
<span class="kn">from</span> <span class="nn">chatterbot.languages</span> <span class="kn">import</span> <span class="n">JPN</span>


<span class="k">class</span> <span class="nc">CustomJPN</span><span class="p">(</span><span class="n">JPN</span><span class="p">):</span>
    <span class="n">ISO_639_1</span> <span class="o">=</span> <span class="s2">&quot;ja_core_news_sm&quot;</span>


<span class="n">CHATTERBOT</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Training from corpus bot on Web app&quot;</span><span class="p">,</span>
    <span class="s2">&quot;tagger_language&quot;</span><span class="p">:</span> <span class="n">CustomJPN</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>参考：<a class="reference external" href="https://chatterbot.readthedocs.io/en/stable/django/settings.html" rel="noopener noreferrer" target="_blank">https://chatterbot.readthedocs.io/en/stable/django/settings.html</a></p>
<p>辞書を指す変数 <code class="docutils literal notranslate"><span class="pre">CHATTERBOT</span></code> を追加しています。
この変数は、Webアプリで <code class="docutils literal notranslate"><span class="pre">ChatBot</span></code> クラスのインスタンスを初期化するときに使われます。
実は <code class="docutils literal notranslate"><span class="pre">ChatBot</span></code> というイニシャライザの第1引数は <code class="docutils literal notranslate"><span class="pre">name</span></code> です。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">chatbot</span> <span class="o">=</span> <span class="n">ChatBot</span><span class="p">(</span>
<span class="hll">    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Training from corpus bot&quot;</span><span class="p">,</span>
</span>    <span class="n">tagger_language</span><span class="o">=</span><span class="n">CustomJPN</span>
<span class="p">)</span>
</pre></div>
</div>
<p><code class="file docutils literal notranslate"><span class="pre">my_chatbot.py</span></code> 同様に日本語を扱うように指定しています（<code class="docutils literal notranslate"><span class="pre">tagger_language</span></code>）。
説明は <a class="reference internal" href="../30-chatterbot-first-step/index.html#chatterbot-first-step"><span class="std std-ref">ChatterBot はじめの一歩</span></a> を参照してください。</p>
</div>
</div>
<div class="section" id="id13">
<h3>訓練するカスタムコマンドを実装<a class="headerlink" href="#id13" title="この見出しへのパーマリンク">¶</a></h3>
<div class="literal-block-wrapper docutils container" id="id25">
<div class="code-block-caption"><span class="caption-text">chat/management/commands/bot_train.py</span><a class="headerlink" href="#id25" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="linenos"> 1</span><span class="kn">from</span> <span class="nn">chatterbot</span> <span class="kn">import</span> <span class="n">ChatBot</span>
</span><span class="hll"><span class="linenos"> 2</span><span class="kn">from</span> <span class="nn">chatterbot.ext.django_chatterbot</span> <span class="kn">import</span> <span class="n">settings</span>
</span><span class="hll"><span class="linenos"> 3</span><span class="kn">from</span> <span class="nn">chatterbot.trainers</span> <span class="kn">import</span> <span class="n">ChatterBotCorpusTrainer</span>
</span><span class="linenos"> 4</span><span class="kn">from</span> <span class="nn">django.core.management.base</span> <span class="kn">import</span> <span class="n">BaseCommand</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="k">class</span> <span class="nc">Command</span><span class="p">(</span><span class="n">BaseCommand</span><span class="p">):</span>
<span class="linenos"> 8</span>    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="hll"><span class="linenos"> 9</span>        <span class="n">chatbot</span> <span class="o">=</span> <span class="n">ChatBot</span><span class="p">(</span><span class="o">**</span><span class="n">settings</span><span class="o">.</span><span class="n">CHATTERBOT</span><span class="p">)</span>
</span><span class="linenos">10</span>
<span class="hll"><span class="linenos">11</span>        <span class="n">trainer</span> <span class="o">=</span> <span class="n">ChatterBotCorpusTrainer</span><span class="p">(</span><span class="n">chatbot</span><span class="p">)</span>
</span><span class="hll"><span class="linenos">12</span>        <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="s2">&quot;chatterbot.corpus.japanese&quot;</span><span class="p">)</span>
</span><span class="linenos">13</span>
<span class="linenos">14</span>        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">(</span><span class="s2">&quot;Training completed.&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>9〜11行目は <code class="file docutils literal notranslate"><span class="pre">my_chatbot.py</span></code> でコーパスから訓練しているコードと同様です。
13行目は訓練終了を出力しています。</p>
<div class="admonition hint">
<p class="first admonition-title">ヒント</p>
<p><code class="docutils literal notranslate"><span class="pre">**settings.CHATTERBOT</span></code> について</p>
<p>この書き方は初めて見たときに混乱するかもしれません。
辞書に <code class="docutils literal notranslate"><span class="pre">**</span></code> を付けて、関数に渡すと、<code class="docutils literal notranslate"><span class="pre">辞書のキー=値</span></code> と <strong>キーワード引数を渡した</strong> ことになります。</p>
<div class="last highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="gp">... </span>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
<span class="gp">... </span>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="go">a 1</span>
<span class="go">b 2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f</span><span class="p">(</span><span class="o">**</span><span class="n">d</span><span class="p">)</span>  <span class="c1"># f(a=1, b=2) という呼び出しと同じになる</span>
<span class="go">a 1</span>
<span class="go">b 2</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id14">
<h3>訓練コマンドを動かすために<a class="headerlink" href="#id14" title="この見出しへのパーマリンク">¶</a></h3>
<ul class="simple">
<li>データベースのセットアップ</li>
<li>ライブラリ <code class="docutils literal notranslate"><span class="pre">chatterbot_corpus</span></code> インストール</li>
</ul>
<p>後者のインストールについては <a class="reference internal" href="../30-chatterbot-first-step/index.html#corpus-train-ja-bot"><span class="std std-ref">コーパスを使って訓練したチャットボット（日本語）</span></a> に対処法を追加しています。</p>
<div class="section" id="id15">
<h4>データベースのセットアップ<a class="headerlink" href="#id15" title="この見出しへのパーマリンク">¶</a></h4>
<p>ChatterBotは訓練に使うコーパスを <strong>データベースに保存</strong> します。</p>
<p>Djangoでデータベースの操作を担うのが <strong>モデル</strong> です。</p>
<iframe width="800" height="480" src="https://ftnext.github.io/2020_slides/pycon_shizu_Feb_django_intro/slide.html#/12/5" title="Djangoで始めるWeb開発の世界 〜Web開発を知らない方に贈る、Django Girls Tutorialとその周辺のクイックツアー〜"></iframe><p>今回の実装の範囲で、私たちがモデルを使ってデータベースを操作することはありませんが、仕組みとして紹介しました
（ChatterBot側でモデルを使ったコードが用意されています）。</p>
<p>データベースのセットアップには <strong class="command">python manage.py migrate</strong> を実行します。
migrate（マイグレート）はデータベースの定義をバージョン管理するイメージです。
DjangoやChatterBotが用意したデータベースの定義を適用しています。</p>
<p>データベースのセットアップが終わったら <strong class="command">python manage.py bot_train</strong> を実行しましょう。
訓練に使ったコーパスの文章がデータベースに保存され、<code class="docutils literal notranslate"><span class="pre">ChatBot</span></code> が検索して返せる状態になります。</p>
</div>
</div>
<div class="section" id="id16">
<h3>発展：訓練コマンドの最終形<a class="headerlink" href="#id16" title="この見出しへのパーマリンク">¶</a></h3>
<div class="literal-block-wrapper docutils container" id="id26">
<div class="code-block-caption"><span class="caption-text">chat/management/commands/bot_train.py</span><a class="headerlink" href="#id26" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">from</span> <span class="nn">chatterbot</span> <span class="kn">import</span> <span class="n">ChatBot</span>
<span class="linenos"> 2</span><span class="kn">from</span> <span class="nn">chatterbot.ext.django_chatterbot</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="hll"><span class="linenos"> 3</span><span class="kn">from</span> <span class="nn">chatterbot.ext.django_chatterbot.models</span> <span class="kn">import</span> <span class="n">Statement</span>
</span><span class="linenos"> 4</span><span class="kn">from</span> <span class="nn">chatterbot.trainers</span> <span class="kn">import</span> <span class="n">ChatterBotCorpusTrainer</span>
<span class="linenos"> 5</span><span class="kn">from</span> <span class="nn">django.core.management.base</span> <span class="kn">import</span> <span class="n">BaseCommand</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="k">class</span> <span class="nc">Command</span><span class="p">(</span><span class="n">BaseCommand</span><span class="p">):</span>
<span class="hll"><span class="linenos"> 9</span>    <span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Train chatbot with corpus&quot;</span>
</span><span class="linenos">10</span>
<span class="linenos">11</span>    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="hll"><span class="linenos">12</span>        <span class="n">statements</span> <span class="o">=</span> <span class="n">Statement</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span class="hll"><span class="linenos">13</span>        <span class="k">if</span> <span class="n">statements</span><span class="p">:</span>
</span><span class="hll"><span class="linenos">14</span>            <span class="n">statements</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</span><span class="hll"><span class="linenos">15</span>            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
</span><span class="hll"><span class="linenos">16</span>                <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">(</span><span class="s2">&quot;All data have been deleted.&quot;</span><span class="p">)</span>
</span><span class="hll"><span class="linenos">17</span>            <span class="p">)</span>
</span><span class="linenos">18</span>
<span class="linenos">19</span>        <span class="n">chatbot</span> <span class="o">=</span> <span class="n">ChatBot</span><span class="p">(</span><span class="o">**</span><span class="n">settings</span><span class="o">.</span><span class="n">CHATTERBOT</span><span class="p">)</span>
<span class="linenos">20</span>
<span class="linenos">21</span>        <span class="n">trainer</span> <span class="o">=</span> <span class="n">ChatterBotCorpusTrainer</span><span class="p">(</span><span class="n">chatbot</span><span class="p">)</span>
<span class="linenos">22</span>        <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="s2">&quot;chatterbot.corpus.japanese&quot;</span><span class="p">)</span>
<span class="linenos">23</span>
<span class="linenos">24</span>        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">(</span><span class="s2">&quot;Training completed.&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li>9行目の <code class="docutils literal notranslate"><span class="pre">help</span></code> 変数が指す文字列は <strong class="command">python manage.py bot_train --help</strong> で表示されます</li>
<li>すでに訓練されている場合、データベースに <code class="docutils literal notranslate"><span class="pre">Statement</span></code> が保存されています。保存が重複しないよう、<em>データベースに保存されたStatementをすべて削除する</em> という実装にしています（この <code class="docutils literal notranslate"><span class="pre">Statement</span></code> がモデルです）</li>
</ul>
</div>
</div>
<div class="section" id="id17">
<h2>訓練したチャットボットとやり取りできるようにする<a class="headerlink" href="#id17" title="この見出しへのパーマリンク">¶</a></h2>
<p>カスタムコマンドでチャットボットを訓練したら、ユーザーがやり取りできるようにしましょう。
オウム返しするチャットボットと差し替えます。</p>
<p>これまでにチャットボットの応答をWebアプリに表示する部分を作成済みなので、 <strong>チャットボットを差し替えるだけ</strong> です。
アプリケーションの <code class="file docutils literal notranslate"><span class="pre">views.py</span></code> を修正します。</p>
<div class="section" id="id18">
<h3>チャットボットが応答するようにビューを変更<a class="headerlink" href="#id18" title="この見出しへのパーマリンク">¶</a></h3>
<p><code class="file docutils literal notranslate"><span class="pre">my_chatbot.py</span></code> でチャットボットとやり取りする部分の実装は以下のようになっています。</p>
<div class="literal-block-wrapper docutils container" id="id27">
<div class="code-block-caption"><span class="caption-text">my_chatbot.py</span><a class="headerlink" href="#id27" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">19</span>            <span class="n">response</span> <span class="o">=</span> <span class="n">chatbot</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">user_input</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">chatbot</span></code> の <code class="docutils literal notranslate"><span class="pre">get_response</span></code> メソッドを呼んでいますね。</p>
<p>Webアプリでも、ビューの <code class="docutils literal notranslate"><span class="pre">bot_response</span></code> 関数も同様の実装にします
（フォームから <code class="docutils literal notranslate"><span class="pre">bot-response/</span></code> にPOSTリクエストが送られるたびに呼ばれる関数でしたね）。</p>
<p>参考</p>
<ul class="simple">
<li><a class="reference external" href="https://chatterbot.readthedocs.io/en/stable/django/views.html" rel="noopener noreferrer" target="_blank">https://chatterbot.readthedocs.io/en/stable/django/views.html</a></li>
<li><a class="reference external" href="https://github.com/gunthercox/ChatterBot/blob/master/examples/django_app/example_app/views.py" rel="noopener noreferrer" target="_blank">https://github.com/gunthercox/ChatterBot/blob/master/examples/django_app/example_app/views.py</a></li>
</ul>
<div class="section" id="id19">
<h4>変更前<a class="headerlink" href="#id19" title="この見出しへのパーマリンク">¶</a></h4>
<div class="literal-block-wrapper docutils container" id="id28">
<div class="code-block-caption"><span class="caption-text">app/chat/views.py</span><a class="headerlink" href="#id28" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">def</span> <span class="nf">bot_response</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="linenos">2</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
<span class="linenos">3</span>        <span class="n">form</span> <span class="o">=</span> <span class="n">ChatMessageForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
<span class="linenos">4</span>        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
<span class="hll"><span class="linenos">5</span>            <span class="n">response_message</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
</span><span class="linenos">6</span>            <span class="n">http_response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">()</span>
<span class="linenos">7</span>            <span class="n">http_response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response_message</span><span class="p">)</span>
<span class="linenos">8</span>            <span class="k">return</span> <span class="n">http_response</span>
</pre></div>
</div>
</div>
<p>オウム返しするチャットボットなので、入力されたテキストをそのまま返しています。</p>
</div>
<div class="section" id="id20">
<h4>変更後<a class="headerlink" href="#id20" title="この見出しへのパーマリンク">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">ChatBot</span></code> インスタンスを初期化します。
ビュー関数が呼び出されるたびに初期化したくないので、関数の外側に書いています。</p>
<div class="literal-block-wrapper docutils container" id="id29">
<div class="code-block-caption"><span class="caption-text">app/chat/views.py</span><a class="headerlink" href="#id29" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="kn">from</span> <span class="nn">chatterbot</span> <span class="kn">import</span> <span class="n">ChatBot</span>
</span><span class="hll"><span class="kn">from</span> <span class="nn">chatterbot.ext.django_chatterbot</span> <span class="kn">import</span> <span class="n">settings</span>
</span><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>

<span class="kn">from</span> <span class="nn">.forms</span> <span class="kn">import</span> <span class="n">ChatMessageForm</span>

<span class="hll"><span class="n">chatbot</span> <span class="o">=</span> <span class="n">ChatBot</span><span class="p">(</span><span class="o">**</span><span class="n">settings</span><span class="o">.</span><span class="n">CHATTERBOT</span><span class="p">)</span>
</span></pre></div>
</div>
</div>
<p>入力されたテキストを <code class="docutils literal notranslate"><span class="pre">get_response</span></code> メソッドに渡し、その返り値をレスポンスとして返します。</p>
<div class="literal-block-wrapper docutils container" id="id30">
<div class="code-block-caption"><span class="caption-text">app/chat/views.py</span><a class="headerlink" href="#id30" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">def</span> <span class="nf">bot_response</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="linenos">2</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
<span class="linenos">3</span>        <span class="n">form</span> <span class="o">=</span> <span class="n">ChatMessageForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
<span class="linenos">4</span>        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
<span class="hll"><span class="linenos">5</span>            <span class="n">input_message</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
</span><span class="hll"><span class="linenos">6</span>            <span class="n">response_message</span> <span class="o">=</span> <span class="n">chatbot</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">input_message</span><span class="p">)</span>
</span><span class="linenos">7</span>            <span class="n">http_response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">()</span>
<span class="linenos">8</span>            <span class="n">http_response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response_message</span><span class="p">)</span>
<span class="linenos">9</span>            <span class="k">return</span> <span class="n">http_response</span>
</pre></div>
</div>
</div>
<p><strong class="command">python manage.py runserver</strong> してから <a class="reference external" href="http://127.0.0.1:8000/" rel="noopener noreferrer" target="_blank">http://127.0.0.1:8000/</a> をブラウザで開くと、訓練したチャットボットとやり取りできます！！</p>
</div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">chatbot-lecture-2021</a></h1>








<h3>ナビゲーション</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../10-overview/index.html">チャットボットとは</a></li>
<li class="toctree-l1"><a class="reference internal" href="../20-environment/index.html">環境構築</a></li>
<li class="toctree-l1"><a class="reference internal" href="../30-chatterbot-first-step/index.html">ChatterBot はじめの一歩</a></li>
<li class="toctree-l1"><a class="reference internal" href="../40-django-app-basic/index.html">Django基礎（チャットボットをWebアプリにするための準備）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../50-send-message-django-app/index.html">チャットボットとやり取りできるようにする</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">ChatterBotのチャットボットとWebアプリでやり取りできるようにする</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">今回の位置づけ</a></li>
<li class="toctree-l2"><a class="reference internal" href="#django">Djangoのカスタムコマンド</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id11">チャットボット訓練コマンド</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id17">訓練したチャットボットとやり取りできるようにする</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference.html">参考文献</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="../50-send-message-django-app/index.html" title="前の章へ">チャットボットとやり取りできるようにする</a></li>
      <li>Next: <a href="../reference.html" title="次の章へ">参考文献</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="検索" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, nikkie.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/60-trained-bot-django-app/index.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>